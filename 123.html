<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>404</title>
</head>
<style>
:root{
    --runTime:3s;
    --jumpTime:0.8s;
    --speed:1;
    --speedUser:1;
}
html,body{
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
body{
    background: linear-gradient(to bottom, skyblue, white);
}
.box{
    position: relative;
    border-bottom: 10px solid black;
    width: 500px;
    height: 150px;
    /* overflow: hidden; */
}
.box::before{
    position: absolute;
    bottom: -9px;
    left: 0;
    content: '';
    width: 510px;
    height: 5px;
    box-shadow: 0px 10px 20px 0px black;
    z-index: -1;
}
.top, .bottom{
    display: none;
    width: 10px;
    height: 50px;
    border: 1px solid black;
    background: rgba(0, 0, 0, 1);
    position: absolute;
    right: -13px;
}
.top{
    top: 0;
}
.bottom{
    bottom: 0%;
}
.move{
    display: block;
    animation: moves var(--runTime) cubic-bezier(var(--speed),var(--speed),var(--speed),var(--speed));
}
.user-run{
    width: 50px;
    height: 50px;
    background: conic-gradient(red, pink,white, pink, red);
    animation: run 1s linear infinite;
}
.user{
    position: absolute;
    bottom: 0;
    left: 100px;
    border: 5px solid black;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    overflow: hidden;
    box-shadow: 0px 0px 10px,inset 0px 0px 10px;
}
.jump-active{
    transform-style: preserve-3d;
    animation: jumps var(--jumpTime) cubic-bezier(var(--speedUser),var(--speedUser),var(--speedUser),var(--speedUser));
}
@keyframes jumps{
    0%{
        transform: translateY(0%);
    }
    50%{
        transform: translateY(-100px) rotateX(60deg);
    }
    100%{
        transform: translateY(0%);
    }
}
@keyframes moves{
    0%{
        transform: translateX(0px);
    }
    100%{
        transform: translateX(-515px);
    }
}
@keyframes run{
    0%{
        transform:  rotate(0deg);
    }
    100%{
        transform: rotate(360deg);
    }
}
#score{
    margin: 0%;
    position: absolute;
    top: 35%;
    background: linear-gradient(to left,#c6d3a6, #b1da49);
    border: 5px double yellow;
}
#end{
    box-shadow: 0 0 10px;
    font-size: 18px;
}
</style>
<body>
     <p id="score">得分：0，等级：0</p>
    <div class="box">
        <div class="user">
            <div class="user-run"></div>
        </div>
        <div class="top"></div>
        <div class="bottom"></div>
        <input type="button" value="结束" onclick="end()" id="end">
    </div>
    <script>
        //声明定时器
        let moveTimer = null;
        let collisionTimer = null;
        let scoreTimer = null;
        //获取对应元素
        const user = document.querySelector('.user');
        const boxTop = document.querySelector('.top');
        const boxBottom = document.querySelector('.bottom');
        const score = document.getElementById('score');
        const root = document.documentElement;
        //默认配置
        const DEFAULT_CONFIG = {
            //基础配置
            moveTime: 4000,
            runTime: 3,
            jumpTime: 0.8,
            count: 0,
            level: 0,
            //最大最小值配置
            maxLevel:10,
            minMoveTime: 1000,
            minRunTime: 1.5,
            minJumpTime: 0.5,
            //步长配置
            runTimeStep: 0.15,
            jumpTimeStep: 0.03,
            moveTimeStep: 500,
        };
        //积分
        var count = DEFAULT_CONFIG.count;
        //开始状态
        var start = false;
        //初始间隔时间
        var moveTime = DEFAULT_CONFIG.moveTime;
        //初始等级
        var level = DEFAULT_CONFIG.level;
        /**
         * 得分函数
         */
        function scoreUpdated(){
            //获取css设置的变量
            var runTime = getComputedStyle(root).getPropertyValue('--runTime');
            var jumpTime = getComputedStyle(root).getPropertyValue('--jumpTime');
            //计分
            count++;
            //css变量正则化
            runTimeMatch = runTime.trim().match(/^(\d*\.?\d+)([a-zA-Z]+)?$/);
            jumpTimeMatch = jumpTime.trim().match(/^(\d*\.?\d+)([a-zA-Z]+)?$/);
            //等级最大值界定
            if(count % 10 === 0 && level < DEFAULT_CONFIG.maxLevel){
                level++;
                //等级提升修改
                moveTime = Math.max(moveTime - DEFAULT_CONFIG.moveTimeStep, DEFAULT_CONFIG.minMoveTime);
                runTimeMatch[1] = Math.max(Number(runTimeMatch[1]) - DEFAULT_CONFIG.runTimeStep, DEFAULT_CONFIG.minRunTime);
                jumpTimeMatch[1] = Math.max(Number(jumpTimeMatch[1]) - DEFAULT_CONFIG.jumpTimeStep, DEFAULT_CONFIG.minJumpTime);
                //修改css变量
                root.style.setProperty('--runTime', `${runTimeMatch[1]}${runTimeMatch[2]}`);
                root.style.setProperty('--jumpTime', `${jumpTimeMatch[1]}${jumpTimeMatch[2]}`);
            }
            //插入内容
            score.innerHTML = `得分：${count}，等级：${level}`;
        }
        /**
         * 小球跳跃函数
         */
        function jumps(){
            user.classList.remove('jump-active');
            void user.offsetWidth;
            user.classList.add('jump-active');
        }
        /**
         * 物块移动函数
         */
        function moves(){
            //随机数字
            let select_num = Math.floor(Math.random() * 10);
            console.log(select_num);
            //移除移动动画
            boxTop.classList.remove('move');
            boxBottom.classList.remove('move');
            //强制重绘
            void boxTop.offsetWidth;
            void boxBottom.offsetWidth;
            //根据随机数添加动画
            if(select_num % 2 === 1){
                boxTop.classList.add('move');
            }else{
                boxBottom.classList.add('move');
            }
        }
        /**
         * 结束函数
         */
        function end(){
            if(start){
                //移除计时器
                clearInterval(moveTimer);
                clearInterval(collisionTimer);
                clearInterval(scoreTimer);
                //移除开始状态
                start = false;
                //清除球体和物块状态
                user.classList.remove('jump-active')
                boxTop.classList.remove('move');
                boxBottom.classList.remove('move');
                //重置积分、等级、间隔时间
                count = 0;
                level = 0
                moveTime = 4000;
                root.style.setProperty('--runTime', `${DEFAULT_CONFIG.runTime}s`);
                root.style.setProperty('--jumpTime', `${DEFAULT_CONFIG.jumpTime}s`);
            }else{alert('尚未开始');return;}
        }
        /**
         * 碰撞函数
         * @param {element, element} element1, element2
         */
        function collision(element1, element2){
            //获取判定对象
            const rect1 = element1.getBoundingClientRect();
            const rect2 = element2.getBoundingClientRect();
            //碰撞判定偏移量
            let offset = 5;
            //碰撞重叠阈值
            let minOverlap = 1;
            //碰撞箱1
            let collisionBox1 = {
                left: rect1.left + offset,
                right: rect1.right - offset,
                top: rect1.top + offset,
                bottom: rect1.bottom - offset
            }
            //碰撞箱2
            let collisionBox2 = {
                left: rect2.left + offset,
                right: rect2.right - offset,
                top: rect2.top + offset,
                bottom: rect2.bottom - offset
            }
            //重叠检测
            let isReallyCollided = (
                //水平方向判定
                collisionBox1.right > collisionBox2.left + minOverlap && 
                collisionBox1.left < collisionBox2.right - minOverlap &&
                //垂直判定
                collisionBox1.top < collisionBox2.bottom - minOverlap &&
                collisionBox1.bottom > collisionBox2.top + minOverlap
            );
            if(isReallyCollided){
                end();
            }
        }
        /**
         * 监听碰撞函数
         */
        function checkcollision(){
            collision(user,boxTop);
            collision(user,boxBottom);
        }
        /**
         * 监听鼠标点击事件
         */
        document.addEventListener('click', (e)=>{
            //点击结束按钮逻辑
            if(e.target.value === '结束'){
                return;
            }
            //开始逻辑
            if(!start){
                start = true;
                //移动障碍
                moveTimer = setInterval(moves, moveTime);
                //监听是否装上障碍
                collisionTimer = setInterval(checkcollision, 50);
                //积分累加
                scoreTimer = setInterval(scoreUpdated,1000);
            }
            jumps();
        });
    </script>
</body>

</html>